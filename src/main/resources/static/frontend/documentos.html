<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Documentos - SSOMA</title>
</head>
<body>
<h1>Gestión de Documentos</h1>

<nav>
    <a href="index.html">Inicio</a> |
    <a href="empresas.html">Empresas</a> |
    <a href="documentos.html">Documentos</a>
</nav>

<!-- Formulario -->
<h2>Crear/Editar Documento</h2>
<form id="documentoForm">
    <input type="hidden" id="documentoId">

    <label>Empresa:</label>
    <select id="empresaId" required>
        <option value="">Seleccione empresa</option>
    </select><br><br>

    <label>Nombre Documento:</label>
    <input type="text" id="nombreDocumento" required><br><br>

    <label>Fecha Vencimiento:</label>
    <input type="date" id="fechaVencimiento" required><br><br>

    <label>URL Documento:</label>
    <input type="url" id="documentoUrl" placeholder="https://..."><br><br>

    <label>Subir Archivo:</label>
    <input type="file" id="archivoInput" accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png">
    <div id="archivoInfo" style="margin-top: 5px; font-size: 12px; color: #666;"></div><br><br>

    <button type="submit" id="btnGuardar">Guardar</button>
    <button type="button" onclick="limpiarForm()">Limpiar</button>
</form>

<!-- Filtros simples -->
<h2>Filtros</h2>
<label>Filtrar por empresa:</label>
<select id="filtroEmpresa" onchange="filtrarDocumentos()">
    <option value="">Todas las empresas</option>
</select>

<button onclick="mostrarVencidos()">Ver Vencidos</button>
<button onclick="mostrarPorVencer()">Ver Por Vencer</button>
<button onclick="cargarDocumentos()">Ver Todos</button>

<!-- Lista -->
<h2>Lista de Documentos</h2>

<table border="1">
    <thead>
    <tr>
        <th>Empresa</th>
        <th>Documento</th>
        <th>Fecha Vencimiento</th>
        <th>Estado</th>
        <th>Archivo</th>
        <th>Acciones</th>
    </tr>
    </thead>
    <tbody id="documentosTable">
    <tr><td colspan="6">Cargando...</td></tr>
    </tbody>
</table>

<script>
    const API_URL = 'http://localhost:8083/api/v1';
    let editando = false;
    let empresas = [];

    // Cargar al inicio
    window.onload = function() {
        cargarEmpresas();
        cargarDocumentos();

        document.getElementById('documentoForm').onsubmit = function(e) {
            e.preventDefault();
            guardarDocumento();
        };

        // Mostrar info del archivo seleccionado
        document.getElementById('archivoInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const archivoInfo = document.getElementById('archivoInfo');

            if (file) {
                archivoInfo.innerHTML = `📎 Archivo seleccionado: ${file.name} (${formatBytes(file.size)})`;
                archivoInfo.style.color = '#666';
            } else {
                archivoInfo.innerHTML = '';
            }
        });
    };

    function formatBytes(bytes, decimals = 2) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
    }

    async function cargarEmpresas() {
        try {
            const response = await fetch(`${API_URL}/empresas`);
            const data = await response.json();

            if (data.success) {
                empresas = data.data;

                // Llenar selects
                const selectEmpresa = document.getElementById('empresaId');
                const filtroEmpresa = document.getElementById('filtroEmpresa');

                empresas.forEach(empresa => {
                    const option1 = new Option(empresa.razon_social, empresa.empresa_id);
                    const option2 = new Option(empresa.razon_social, empresa.empresa_id);
                    selectEmpresa.add(option1);
                    filtroEmpresa.add(option2);
                });
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    async function cargarDocumentos() {
        try {
            let todosDocumentos = [];

            for (const empresa of empresas) {
                const response = await fetch(`${API_URL}/documentos-empresa/empresa/${empresa.empresa_id}`);
                const data = await response.json();

                if (data.success && data.data) {
                    todosDocumentos = todosDocumentos.concat(data.data);
                }
            }

            mostrarDocumentos(todosDocumentos);
        } catch (error) {
            console.error('Error:', error);
            alert('Error cargando documentos');
        }
    }

    function mostrarDocumentos(documentos) {
        const tbody = document.getElementById('documentosTable');

        if (documentos.length > 0) {
            tbody.innerHTML = documentos.map(doc => {
                const empresa = empresas.find(e => e.empresa_id === doc.empresa_id);
                const empresaNombre = empresa ? empresa.razon_social : 'N/A';
                const estado = getEstado(doc.fecha_vencimiento);

                // Determinar si es archivo local o URL externa
                let archivoInfo = '-';
                if (doc.documento_url) {
                    if (doc.documento_url.includes('/archivos/download/')) {
                        // Es un archivo subido localmente
                        const fileName = doc.documento_url.split('/').pop();
                        archivoInfo = `<a href="${doc.documento_url}" target="_blank">📄 ${fileName}</a>`;
                    } else {
                        // Es una URL externa
                        archivoInfo = `<a href="${doc.documento_url}" target="_blank">🔗 URL</a>`;
                    }
                }

                return `
                    <tr>
                        <td>${empresaNombre}</td>
                        <td>${doc.nombre_documento}</td>
                        <td>${doc.fecha_vencimiento || '-'}</td>
                        <td>${estado}</td>
                        <td>${archivoInfo}</td>
                        <td>
                            <button onclick="editarDocumento('${doc.documento_empresa_id}')">Editar</button>
                            <button onclick="eliminarDocumento('${doc.documento_empresa_id}')">Eliminar</button>
                        </td>
                    </tr>
                `;
            }).join('');
        } else {
            tbody.innerHTML = '<tr><td colspan="6">No hay documentos</td></tr>';
        }
    }

    function getEstado(fechaVencimiento) {
        if (!fechaVencimiento) return 'Sin fecha';

        const hoy = new Date();
        const vencimiento = new Date(fechaVencimiento);

        if (vencimiento < hoy) return '🔴 Vencido';

        const dias = Math.ceil((vencimiento - hoy) / (1000 * 60 * 60 * 24));
        if (dias <= 30) return '🟡 Por vencer';

        return '🟢 Vigente';
    }

    async function subirArchivoSiExiste() {
        const fileInput = document.getElementById('archivoInput');
        const file = fileInput.files[0];

        if (!file) {
            // No hay archivo seleccionado, retornar URL actual
            return document.getElementById('documentoUrl').value || null;
        }

        // Validar tamaño (10MB)
        if (file.size > 10 * 1024 * 1024) {
            throw new Error('El archivo es muy grande. Máximo permitido: 10MB');
        }

        const formData = new FormData();
        formData.append('file', file);

        document.getElementById('archivoInfo').innerHTML = 'Subiendo archivo...';
        document.getElementById('archivoInfo').style.color = '#666';

        const response = await fetch(`${API_URL}/archivos/upload`, {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            document.getElementById('archivoInfo').innerHTML =
                `✅ Archivo subido: ${data.data.originalName}`;
            document.getElementById('archivoInfo').style.color = 'green';

            return `${API_URL}/archivos/download/${data.data.fileName}`;
        } else {
            throw new Error(data.message || 'Error subiendo archivo');
        }
    }

    async function guardarDocumento() {
        const btnGuardar = document.getElementById('btnGuardar');

        try {
            // Validar que haya URL o archivo
            const documentoUrl = document.getElementById('documentoUrl').value;
            const archivo = document.getElementById('archivoInput').files[0];

            if (!documentoUrl && !archivo) {
                alert('Debes proporcionar una URL del documento o subir un archivo');
                return;
            }

            // Deshabilitar botón y mostrar que está procesando
            btnGuardar.disabled = true;
            btnGuardar.textContent = 'Guardando...';

            // Subir archivo si existe
            const finalDocumentoUrl = await subirArchivoSiExiste();

            const documento = {
                empresa_id: document.getElementById('empresaId').value,
                nombre_documento: document.getElementById('nombreDocumento').value,
                fecha_vencimiento: document.getElementById('fechaVencimiento').value,
                documento_url: finalDocumentoUrl
            };

            let response;
            if (editando) {
                const id = document.getElementById('documentoId').value;
                response = await fetch(`${API_URL}/documentos-empresa/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(documento)
                });
            } else {
                response = await fetch(`${API_URL}/documentos-empresa`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(documento)
                });
            }

            const data = await response.json();

            if (data.success) {
                alert(editando ? 'Documento actualizado exitosamente' : 'Documento creado exitosamente');
                limpiarForm();
                cargarDocumentos();
            } else {
                alert('Error: ' + data.message);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error guardando documento: ' + error.message);
            document.getElementById('archivoInfo').innerHTML = '❌ Error: ' + error.message;
            document.getElementById('archivoInfo').style.color = 'red';
        } finally {
            // Restaurar botón
            btnGuardar.disabled = false;
            btnGuardar.textContent = 'Guardar';
        }
    }

    async function editarDocumento(id) {
        try {
            const response = await fetch(`${API_URL}/documentos-empresa/${id}`);
            const data = await response.json();

            if (data.success) {
                const doc = data.data;
                document.getElementById('documentoId').value = doc.documento_empresa_id;
                document.getElementById('empresaId').value = doc.empresa_id;
                document.getElementById('nombreDocumento').value = doc.nombre_documento || '';
                document.getElementById('fechaVencimiento').value = doc.fecha_vencimiento || '';
                document.getElementById('documentoUrl').value = doc.documento_url || '';

                // Mostrar info si hay archivo
                if (doc.documento_url && doc.documento_url.includes('/archivos/download/')) {
                    const fileName = doc.documento_url.split('/').pop();
                    document.getElementById('archivoInfo').innerHTML =
                        `📄 Archivo actual: ${fileName}`;
                    document.getElementById('archivoInfo').style.color = 'blue';
                }

                editando = true;
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error cargando documento');
        }
    }

    async function eliminarDocumento(id) {
        if (confirm('¿Eliminar documento?')) {
            try {
                const response = await fetch(`${API_URL}/documentos-empresa/${id}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    alert('Documento eliminado');
                    cargarDocumentos();
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error eliminando documento');
            }
        }
    }

    async function filtrarDocumentos() {
        const empresaId = document.getElementById('filtroEmpresa').value;

        if (empresaId) {
            try {
                const response = await fetch(`${API_URL}/documentos-empresa/empresa/${empresaId}`);
                const data = await response.json();

                if (data.success) {
                    mostrarDocumentos(data.data);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        } else {
            cargarDocumentos();
        }
    }

    async function mostrarVencidos() {
        try {
            const response = await fetch(`${API_URL}/documentos-empresa/vencidos`);
            const data = await response.json();

            if (data.success) {
                mostrarDocumentos(data.data);
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    async function mostrarPorVencer() {
        try {
            const response = await fetch(`${API_URL}/documentos-empresa/por-vencer?diasAnticipacion=30`);
            const data = await response.json();

            if (data.success) {
                mostrarDocumentos(data.data);
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    function limpiarForm() {
        document.getElementById('documentoForm').reset();
        document.getElementById('documentoId').value = '';
        document.getElementById('archivoInfo').innerHTML = '';
        document.getElementById('archivoInput').value = '';
        editando = false;
    }
</script>
</body>
</html>