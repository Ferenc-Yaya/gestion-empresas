<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Empresas - SSOMA</title>
</head>
<body>
<h1>Gestión de Empresas</h1>

<nav>
    <a href="index.html">Inicio</a> |
    <a href="empresas.html">Empresas</a> |
    <a href="documentos.html">Documentos</a>
</nav>

<!-- Formulario -->
<h2>Crear/Editar Empresa</h2>
<form id="empresaForm">
    <input type="hidden" id="empresaId">

    <label>RUC:</label>
    <input type="text" id="ruc"><br><br>

    <label>Razón Social:</label>
    <input type="text" id="razonSocial" required><br><br>

    <label>Dirección:</label>
    <input type="text" id="direccion"><br><br>

    <label>Sector:</label>
    <input type="text" id="sector"><br><br>

    <label>Score Seguridad (0-100):</label>
    <input type="number" id="scoreSeguridad" min="0" max="100"><br><br>

    <button type="submit">Guardar</button>
    <button type="button" onclick="limpiarForm()">Limpiar</button>
</form>

<!-- Lista -->
<h2>Lista de Empresas</h2>
<button onclick="cargarEmpresas()">Actualizar Lista</button>

<table border="1">
    <thead>
    <tr>
        <th>RUC</th>
        <th>Razón Social</th>
        <th>Sector</th>
        <th>Score</th>
        <th>Acciones</th>
    </tr>
    </thead>
    <tbody id="empresasTable">
    <tr><td colspan="5">Cargando...</td></tr>
    </tbody>
</table>

<script src="app.js"></script>
<script>
//  const API_URL = 'http://localhost:8083/api/v1';
    let editando = false;

    // Cargar empresas al inicio
    document.addEventListener('DOMContentLoaded', function() {
        cargarEmpresas();

        // Configurar formulario
        document.getElementById('empresaForm').onsubmit = function(e) {
            e.preventDefault();
            guardarEmpresa();
        };
    });

    async function cargarEmpresas() {
        try {
            const response = await fetch(`${API_URL}/empresas`);
            const data = await response.json();

            const tbody = document.getElementById('empresasTable');

            if (data.success && data.data.length > 0) {
                tbody.innerHTML = data.data.map(empresa => `
                    <tr>
                        <td>${empresa.ruc || '-'}</td>
                        <td>${empresa.razon_social}</td>
                        <td>${empresa.sector || '-'}</td>
                        <td>${empresa.score_seguridad || '-'}</td>
                        <td>
                            <button onclick="editarEmpresa('${empresa.empresa_id}')">Editar</button>
                            <button onclick="eliminarEmpresa('${empresa.empresa_id}')">Eliminar</button>
                        </td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="5">No hay empresas</td></tr>';
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error cargando empresas');
        }
    }

    async function guardarEmpresa() {
        console.log('guardarEmpresa() ejecutándose'); // ← AGREGAR ESTA LÍNEA

        const empresa = {
            ruc: document.getElementById('ruc').value || null,
            razon_social: document.getElementById('razonSocial').value,
            direccion: document.getElementById('direccion').value || null,
            sector: document.getElementById('sector').value || null,
            score_seguridad: document.getElementById('scoreSeguridad').value ?
                parseInt(document.getElementById('scoreSeguridad').value) : null
        };

        console.log('Datos a enviar:', empresa); // ← AGREGAR ESTA LÍNEA

        try {
            let response;
            if (editando) {
                const id = document.getElementById('empresaId').value;
                response = await fetch(`${API_URL}/empresas/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(empresa)
                });
            } else {
                console.log('Enviando POST a:', `${API_URL}/empresas`); // ← AGREGAR ESTA LÍNEA
                response = await fetch(`${API_URL}/empresas`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(empresa)
                });
            }

            console.log('Respuesta recibida:', response); // ← AGREGAR ESTA LÍNEA
            const data = await response.json();
            console.log('Data:', data); // ← AGREGAR ESTA LÍNEA

            if (data.success) {
                alert(editando ? 'Empresa actualizada' : 'Empresa creada');
                limpiarForm();
                cargarEmpresas();
            } else {
                alert('Error: ' + data.message);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error guardando empresa');
        }
    }

    async function editarEmpresa(id) {
        try {
            const response = await fetch(`${API_URL}/empresas/${id}`);
            const data = await response.json();

            if (data.success) {
                const empresa = data.data;
                document.getElementById('empresaId').value = empresa.empresa_id;
                document.getElementById('ruc').value = empresa.ruc || '';
                document.getElementById('razonSocial').value = empresa.razon_social || '';
                document.getElementById('direccion').value = empresa.direccion || '';
                document.getElementById('sector').value = empresa.sector || '';
                document.getElementById('scoreSeguridad').value = empresa.score_seguridad || '';

                editando = true;
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error cargando empresa');
        }
    }

    async function eliminarEmpresa(id) {
        if (confirm('¿Eliminar empresa?')) {
            try {
                const response = await fetch(`${API_URL}/empresas/${id}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    alert('Empresa eliminada');
                    cargarEmpresas();
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error eliminando empresa');
            }
        }
    }

    function limpiarForm() {
        document.getElementById('empresaForm').reset();
        document.getElementById('empresaId').value = '';
        editando = false;
    }
</script>
</body>
</html>